<div class="tts-container" style="padding-bottom: 2em; margin-bottom: 2em; border-bottom: 1px solid #eee;">
  <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <button id="tts-button" class="pure-button tts-button" style="display: flex; align-items: center; gap: 8px; font-family: inherit; font-weight: 600; background: #1f8dd6; color: white; border-radius: 4px; padding: 0.5em 1.5em;">
      <span id="tts-icon">ðŸ”Š</span>
      <span id="tts-text">Listen to this article</span>
    </button>
    <div id="tts-status" style="font-size: 0.9em; color: #777; font-style: italic;">Ready</div>
  </div>
</div>

<script>
(function() {
  const config = { speed: 1.0, pitch: 1.0, volume: 1.0 };
  let isPaused = false;
  let isPlaying = false;
  let allVoices = [];
  let selectedVoice = null;
  let textChunks = [];
  let currentChunkIndex = 0;
  
  // Progress tracking for Android/System voices
  let lastKnownCharIndex = 0;
  let tickerInterval = null;
  const ESTIMATED_CHARS_PER_SEC = 15; 

  const isAndroid = /Android/i.test(navigator.userAgent);
  const isChrome = /Chrome/i.test(navigator.userAgent);

  window._ttsUtterance = null;
  let button, buttonIcon, buttonText, statusDiv;

  function setStatus(msg, isErr = false) {
    if (statusDiv) {
      statusDiv.textContent = msg;
      statusDiv.style.color = isErr ? "#b91d47" : "#777";
    }
  }

  function updateUI(state) {
    if (!button) return;
    if (state === 'playing') {
      buttonIcon.textContent = 'â¸ï¸'; 
      buttonText.textContent = 'Pause'; 
      button.style.background = '#e91e63'; // Blackburn accent
    } else if (state === 'paused') {
      buttonIcon.textContent = 'â–¶ï¸'; 
      buttonText.textContent = 'Resume'; 
      button.style.background = '#1f8dd6';
    } else {
      buttonIcon.textContent = 'ðŸ”Š'; 
      buttonText.textContent = 'Listen to this article'; 
      button.style.background = '#1f8dd6';
    }
  }

  function loadVoices() {
    return new Promise((resolve) => {
      const synth = window.speechSynthesis;
      const trySelect = () => {
        allVoices = synth.getVoices();
        if (allVoices.length > 0) {
          const voiceTiers = [
            ['Microsoft Jenny', 'Microsoft Aria'],
            ['Google UK English', 'Google US English', 'Google English'],
            ['en-US', 'en-GB'],
            ['default']
          ];
          for (const tier of voiceTiers) {
            for (const name of tier) {
              let match = allVoices.find(v => v.name.includes(name) || v.lang.includes(name));
              if (match) { selectedVoice = match; resolve(); return; }
            }
          }
          selectedVoice = allVoices[0];
          resolve();
        }
      };
      if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = trySelect;
      trySelect();
    });
  }

  function getCleanArticleText() {
    const selectors = ['article', '.post-content', '.content', 'main', '#content', '.entry-content'];
    let content = null;
    for (const s of selectors) {
      const el = document.querySelector(s);
      if (el) { content = el; break; }
    }
    if (!content) content = document.body;
    const clone = content.cloneNode(true);
    const exclude = [
      'script', 'style', 'nav', 'header', 'footer', '.post-meta','.tts-container', 
      'button', 'aside', '.sidebar', '#comments', '.social-share', 
      '.menu', '.nav-menu', '.table-of-contents'
    ];
    exclude.forEach(s => clone.querySelectorAll(s).forEach(el => el.remove()));
    return (clone.innerText || clone.textContent).replace(/\s+/g, ' ').trim();
  }

  function startTicker() {
    if (tickerInterval) clearInterval(tickerInterval);
    tickerInterval = setInterval(() => {
      if (!window.speechSynthesis.paused && isPlaying) {
        lastKnownCharIndex += (ESTIMATED_CHARS_PER_SEC * config.speed) * 0.2;
      }
    }, 200);
  }

  function stopTicker() {
    if (tickerInterval) clearInterval(tickerInterval);
  }

  function speakChunk(offset = 0) {
    if (currentChunkIndex >= textChunks.length) {
      isPlaying = false; 
      updateUI('default'); 
      setStatus('Finished');
      stopTicker();
      return;
    }

    const synth = window.speechSynthesis;
    const fullText = textChunks[currentChunkIndex];
    const textToSpeak = fullText.substring(Math.floor(offset));

    window._ttsUtterance = new SpeechSynthesisUtterance(textToSpeak);
    window._ttsUtterance.voice = selectedVoice;
    window._ttsUtterance.rate = config.speed;

    window._ttsUtterance.onboundary = (event) => {
      if (event.name === 'word') {
        lastKnownCharIndex = offset + event.charIndex;
      }
    };

    window._ttsUtterance.onstart = () => {
      isPlaying = true; 
      isPaused = false;
      updateUI('playing'); 
      setStatus('Reading...');
      startTicker();
    };

    window._ttsUtterance.onend = () => {
      if (!isPaused) {
        currentChunkIndex++;
        lastKnownCharIndex = 0;
        speakChunk();
      }
    };

    window._ttsUtterance.onerror = (e) => {
      if (e.error !== 'interrupted') {
        isPlaying = false; 
        updateUI('default');
      }
    };

    synth.speak(window._ttsUtterance);
    if (synth.paused) synth.resume();
  }

  async function toggleSpeech() {
    const synth = window.speechSynthesis;

    if (isPlaying && !isPaused) {
      synth.pause();
      isPaused = true;
      stopTicker();
      updateUI('paused');
      setStatus('Paused');
      return;
    }

    if (isPaused) {
      if (isAndroid && isChrome) {
        // Force restart for Android to pick up the ticker index
        synth.cancel();
        setTimeout(() => speakChunk(lastKnownCharIndex), 60);
      } else {
        isPaused = false;
        synth.resume();
        startTicker();
        setTimeout(() => {
          if (isPaused === false && (!synth.speaking || synth.paused)) {
            synth.cancel();
            speakChunk(lastKnownCharIndex);
          }
        }, 400);
      }
      updateUI('playing');
      setStatus('Reading...');
      return;
    }

    // New Session
    synth.cancel();
    setTimeout(async () => {
      await loadVoices();
      const rawText = document.querySelector(".header h1").textContent + "." + getCleanArticleText();
      textChunks = rawText.match(/[^\.!\?]+[\.!\?]+/g) || [rawText];
      textChunks = textChunks.map(t => t.trim()).filter(t => t.length > 0);
      
      currentChunkIndex = 0;
      lastKnownCharIndex = 0;
      isPaused = false;
      if (textChunks.length > 0) speakChunk();
      else setStatus('No text found', true);
    }, 150);
  }

  function init() {
    button = document.getElementById('tts-button');
    buttonIcon = document.getElementById('tts-icon');
    buttonText = document.getElementById('tts-text');
    statusDiv = document.getElementById('tts-status');

    if (button) button.addEventListener('click', toggleSpeech);

    if ('speechSynthesis' in window) {
      loadVoices().then(() => setStatus('Ready'));
    } else {
      setStatus('Not supported', true);
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
  
  window.addEventListener('beforeunload', () => {
    stopTicker();
    window.speechSynthesis.cancel();
  });
})();
</script>

<style>
.tts-button { 
  transition: background 0.2s ease, transform 0.1s ease; 
  border: none; 
  outline: none; 
  cursor: pointer;
}
.tts-button:hover { filter: brightness(110%); }
.tts-button:active { transform: translateY(1px); }
@media (prefers-color-scheme: dark) {
  .tts-container { border-bottom-color: #333 !important; }
  #tts-status { color: #999 !important; }
}
</style>