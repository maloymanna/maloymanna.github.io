name: Build

on:
  workflow_run:
    workflows: ["Tests"]   # must match the name: field in tests.yml exactly
    types: [completed]
    branches: [master]

permissions:
  contents: read
  actions: write # needed to upload artifacts

jobs:
  build:
    runs-on: ubuntu-latest

    # Only run if tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.141.0"
          extended: true
                          
      - name: Build
        run: hugo --minify

      - name: Install Pagefind 1.4.0
        run: |
          echo "â¬‡ï¸ Downloading Pagefind 1.4.0..."
          wget -q https://github.com/Pagefind/pagefind/releases/download/v1.4.0/pagefind-v1.4.0-x86_64-unknown-linux-musl.tar.gz -O /tmp/pagefind.tar.gz
          tar -xzf /tmp/pagefind.tar.gz -C /usr/local/bin pagefind
          chmod +x /usr/local/bin/pagefind
          echo "âœ“ Pagefind installed"
          pagefind --version

      - name: Build Pagefind search index
        run: |
          echo "ğŸ” Generating Pagefind index..."
          pagefind --site public --output-path public/pagefind
          echo "âœ“ Pagefind index generated"

      - name: Verify Pagefind index was created
        run: |
          echo "ğŸ“ Verifying index files..."
          ls -lh public/pagefind/
          test -f public/pagefind/pagefind.js || \
            (echo "ERROR: public/pagefind/pagefind.js not found â€” indexing failed" && exit 1)
          test -f public/pagefind/pagefind-entry.json || \
            (echo "ERROR: public/pagefind/pagefind-entry.json not found â€” indexing failed" && exit 1)
          test -f public/pagefind/wasm.en.pagefind || \
            (echo "ERROR: public/pagefind/wasm.en.pagefind not found â€” indexing failed" && exit 1)
          echo "âœ“ All Pagefind files present"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./public
          retention-days: 1
          if-no-files-found: error
